<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medexa AI</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='beyond.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #007bff;
            --accent: #10ac84;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --glass: rgba(255, 255, 255, 0.85);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-gradient); height: 100vh; display: flex; justify-content: center; align-items: center; }

        /* Main Container */
        .app-container {
            width: 95%; max-width: 480px; height: 90vh;
            background: var(--glass); backdrop-filter: blur(15px);
            border-radius: 25px; box-shadow: var(--shadow);
            display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Header */
        .header {
            padding: 20px; background: white; border-bottom: 1px solid #eee;
            display: flex; align-items: center; gap: 12px;
        }
        .header img { width: 45px; border-radius: 50%; border: 2px solid var(--primary); }
        .header h1 { font-size: 1.1rem; color: #2d3436; }
        .header p { font-size: 0.7rem; color: var(--accent); font-weight: 600; text-transform: uppercase; }

        /* Chat Body */
        .chat-body {
            flex: 1; padding: 20px; overflow-y: auto;
            background: rgba(249, 251, 255, 0.5);
            display: flex; flex-direction: column; gap: 15px;
        }
        .msg-wrapper { display: flex; max-width: 85%; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } }
        
        .msg-wrapper.bot { align-self: flex-start; }
        .msg-wrapper.user { align-self: flex-end; }
        
        .message {
            padding: 12px 16px; border-radius: 18px; font-size: 0.95rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;
        }
        .bot .message { background: white; color: #2d3436; border-bottom-left-radius: 4px; }
        .user .message { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        
        .msg-time { display: block; font-size: 0.6rem; margin-top: 5px; opacity: 0.6; }

        /* Preview Area */
        #img-preview { 
            display: none; padding: 10px 20px; background: #fff; 
            border-top: 1px solid #eee; align-items: center; gap: 10px;
        }
        #img-preview img { height: 50px; border-radius: 8px; border: 1px solid #ddd; }

        /* Footer / Inputs */
        .footer { padding: 15px 20px; background: white; }
        .input-box {
            display: flex; background: #f1f3f6; border-radius: 30px;
            padding: 5px 15px; align-items: center; gap: 10px;
        }
        .input-box input { flex: 1; background: none; border: none; outline: none; padding: 10px 0; }
        
        .icon-btn { color: #636e72; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .icon-btn:hover { color: var(--primary); }
        .send-btn {
            background: var(--primary); color: white; border: none;
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer;
        }
        
        /* Recording Animation */
        .recording { color: #e74c3c; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="app-container">
      <div class="header">
    <img src="{{ url_for('static', filename='beyond.png') }}" alt="My Logo">
    <div>
        <h1>Medexa AI</h1>
        <p id="ai-status">● Professional Medical Assistant</p>
    </div>
    <div id="ai-wave" class="speaking-indicator">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
</div>

        <div id="messageFormeight" class="chat-body">
            <div class="msg-wrapper bot">
                <div class="message">
                    Welcome! I'm your medical assistant. You can type, speak, or upload a photo of a symptom for analysis.
                    <span class="msg-time">System</span>
                </div>
            </div>
        </div>

        <div id="img-preview">
            <img id="preview-src" src="" alt="preview">
            <span style="font-size: 0.8rem; color: #636e72;">Image Attached</span>
            <i class="fas fa-times-circle" style="margin-left:auto; cursor:pointer;" onclick="clearImage()"></i>
        </div>

        <div class="footer">
            <form id="messageArea" class="input-box" enctype="multipart/form-data">
                <label for="imageInput" class="icon-btn"><i class="fas fa-camera"></i></label>
                <input type="file" id="imageInput" name="image" accept="image/*" style="display:none;">
                
                <input type="text" id="text" name="msg" placeholder="Describe symptoms..." autocomplete="off">
                
                <i id="mic-btn" class="fas fa-microphone icon-btn"></i>
                <button type="submit" class="send-btn"><i class="fas fa-paper-plane"></i></button>
            </form>
            <p style="font-size: 0.6rem; text-align:center; color:#b2bec3; margin-top:8px;">
                Disclaimer: AI advice is for informational use only.
            </p>
        </div>
    </div>
     <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        // --- 1. Image Preview Logic ---
        $("#imageInput").change(function() {
            if (this.files && this.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#preview-src').attr('src', e.target.result);
                    $('#img-preview').css('display', 'flex');
                }
                reader.readAsDataURL(this.files[0]);
            }
        });

        function clearImage() {
            $("#imageInput").val("");
            $('#img-preview').hide();
        }

     // --- Updated Voice-to-Text (User Speaking) ---
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'en-US';

$('#mic-btn').click(() => {
    recognition.start();
});

recognition.onstart = () => {
    $('#mic-btn').addClass('recording-active');
    console.log("User is speaking...");
};

recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    $('#text').val(transcript);
    $("#messageArea").submit();
};

recognition.onend = () => {
    $('#mic-btn').removeClass('recording-active');
};

// --- Updated Text-to-Speech (AI Speaking) ---
function speak(text) {
    const synth = window.speechSynthesis;
    const utterance = new SpeechSynthesisUtterance(text);
    
    utterance.onstart = () => {
        // Show AI speaking wave
        $('#ai-wave').css('display', 'flex');
        $('#ai-status').text('● Medexa is speaking...');
    };

    utterance.onend = () => {
        // Hide AI speaking wave
        $('#ai-wave').hide();
        $('#ai-status').html('● Professional Medical Assistant');
    };

    utterance.rate = 1.0; 
    synth.speak(utterance);
}


        // --- 4. Main AJAX Chat Logic ---
        $(document).ready(function() {
            $("#messageArea").on("submit", function(event) {
                event.preventDefault();
                const date = new Date();
                const time = date.getHours() + ":" + date.getMinutes().toString().padStart(2, '0');
                const rawText = $("#text").val();
                
                if(!rawText && !$("#imageInput").val()) return;

                // User UI
                const userHtml = `<div class="msg-wrapper user"><div class="message">${rawText || "Sent an image"}<span class="msg-time">${time}</span></div></div>`;
                $("#messageFormeight").append(userHtml);
                
                // Scrolling
                $(".chat-body").stop().animate({ scrollTop: $(".chat-body")[0].scrollHeight}, 500);

                // Prepare Data
                var formData = new FormData(this);
                $("#text").val("");
                clearImage();

                // Loading state
                const typing = $('<div class="msg-wrapper bot"><div class="message">...</div></div>');
                $("#messageFormeight").append(typing);

                $.ajax({
                    type: "POST",
                    url: "/get",
                    data: formData,
                    processData: false,
                    contentType: false,
                }).done(function(data) {

                    if (data === "TRIGGER_EMERGENCY") {
        window.location.href = "/emergency"; // Redirect instantly
        return;
    }
    typing.remove();
    
    // Use marked.parse() to convert Markdown to clean HTML
    const cleanHtml = marked.parse(data);
    
    const botHtml = `
        <div class="msg-wrapper bot">
            <div class="message">
                ${cleanHtml}
                <span class="msg-time">${time}</span>
            </div>
        </div>`;
    
    $("#messageFormeight").append(botHtml);
    $(".chat-body").stop().animate({ scrollTop: $(".chat-body")[0].scrollHeight}, 500);
    
    // Trigger Voice Response (using the raw text for speech)
    speak(data);
});
            });
        });
    </script>
</body>
</html>